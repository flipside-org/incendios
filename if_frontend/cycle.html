<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.4.1.min.css">
  <link rel="stylesheet/less" type="text/css" href="css/styles.less" />


  <script type="text/javascript">
  less = {
        env: "development", // or "production"
        async: false,       // load imports async
        fileAsync: false,   // load imports async when in a page under
                            // a file protocol
        poll: 1000,         // when in watch mode, time in ms between polls
        functions: {},      // user functions, keyed by name
        dumpLineNumbers: "comments", // or "mediaQuery" or "all"
        relativeUrls: false,// whether to adjust url's to be relative
                            // if false, url's are already relative to the
                            // entry less file
        rootpath: "/incendios/if_frontend/css/"// a path to add on to the start of every url
                            //resource
  };
  </script>
  <script src="https://raw.github.com/cloudhead/less.js/master/dist/less-1.3.3.min.js" type="text/javascript"></script>

  <script src='http://api.tiles.mapbox.com/mapbox.js/v0.6.7/mapbox.js'></script>
  <link href='http://api.tiles.mapbox.com/mapbox.js/v0.6.7/mapbox.css' rel='stylesheet' />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
</head>
<body>
  <div class="container-fluid cf">
    <header class="row-fluid">
      <h1 class="site-name">Incendios <small>a project by flipside</small></h1>
    </header>
    <div class="row-fluid">
      <div id="map" class="span12 map"> <!-- Map -->
      </div>
      <div id="overlay" class="span5">
        <div class="overview">
          <h2>Viseu</h2>
          <select>
          	<option value="d">Viseu</option>
          </select>
          <select>
          	<option value="c">Concelho</option>
          </select>
          <select>
          	<option value="f">Freguesia</option>
          </select>
          <p>This shows data for fires that started in this administratie area. The fire might have spread outside this administrative area. This is merely the origin point.</p>
        </div>

        <div class="box">
          <h3>Fire type per year</h3>
          <div id="fires-year"></div>
          <h3>Burnt area per year</h3>
          <div id="burnt-area"></div>
        </div>

      </div>
    </div>
    <div class="row-fluid">
      <div class="span12 map-links"></div>
    </div>
  </div>
  <div class="container">
    <div class="row">
      <div class="limiter">
        <div class="span3">
          <h2>Project Information</h2>
          <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque mauris lorem, scelerisque sed pellentesque a, accumsan non neque. Vestibulum in eros nisl. Praesent ac erat non mauris sodales tempus. Suspendisse imperdiet dignissim neque, et lacinia libero aliquet eu. Sed consectetur sollicitudin orci ut ultrices. In enim turpis, vehicula nec ultrices sit amet, suscipit in dolor. Vestibulum in <a href="#">link in text</a> quam. Donec ultricies augue id magna molestie interdum. Aliquam metus libero, elementum nec fermentum nec, aliquet ut urna. Phasellus a sodales odio. Sed fringilla, magna commodo euismod ornare, augue dui congue urna, a dapibus dolor velit quis diam.</p>
        </div>
        <div class="span6">
          <div class="chart first">
            <h3>Content title<span>, 2001-2012</span></h3>
            <div class=""><img src="" width="430" height="225" alt=""></div>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque mauris lorem, scelerisque sed pellentesque a, accumsan non neque.</p>
          </div>
          <div class="chart">
            <h3>Lorem ipsum H3 title long long long with linebreak</h3>
            <div class=""><img src="" width="430" height="225" alt=""></div>
            <ul class="icons-25">
                <li>pos 1</li>
                <li>pos 2</li>
                <li>pos 3</li>
                <li>pos 4</li>
                <li>pos 5</li>
                <li>pos 6</li>
            </ul>
          </div>
        </div>
        <div class="span3">
          <div>
            <h4>Sidebar title for paragraphs</h4>
            <p class="bignum">354</p>
            <p class="infoheader">Info header</p>
            <p class="smallnum">2011 (72)</p>
            <p class="infoheader">Info header</p>
            <p class="mediumnum">January (40)</p>
          </div>
          <div>
            <h4>Sidebar title for list</h4>
            <ul id="bnOrgs">
              <li class="smallnum">List item 1</li>
              <li class="smallnum">List item 2</li>
              <li class="smallnum">List item 3</li>
              <li class="smallnum">list item with line break to long text yeah</li>
              <li class="smallnum">more list items</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="span4">
        <h2>Open Data</h2>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque mauris lorem, scelerisque sed pellentesque a, accumsan non neque.</p>
      </div>
      <div class="span4">
        <h3>Download</h3>
        <p>Download a .csv document containing all reports visible on this site for use in a spreadsheet program or <a href="#">Link</a>.</p>
      </div>
      <div class="span4">
        <h3>More Content Box with line break</h3>
        <p><a href="#" title="">API Data Feed</a></p>
        <p>Access this data as a JSON API feed for programmatic use in a web application.</p>
      </div>
    </div>
  </div>
  <footer id="footer">
    <div class="container">
      <div class="row">
        <div class="span12">
          <p>Being built by Flipside</p>
        </div>
      </div>
    </div>
  </footer>


  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
  <script src="http://cdn.oesmith.co.uk/morris-0.4.1.min.js"></script>
  <script>
  $(document).ready(function(){
    // Variable declaration.
    // Active layer number.
    var active_layer = 0;
    // Control Variable.
    var sliding = true;
    // Windows Focused.
    var focused = true;
    // Layer's variables. Layer being faded in and out.
    var l_out;
    var l_in;
    // Timeout
    var timeout;
    var l_out_timeout;
    var l_in_timeout;
    // Base
    var base_map = 'flipside.map-epnw0q4t';
    // Occurrences.
    var layers = [
      {
        year: 2001,
        map: 'flipside.if-occurrences-2001'
      },
      {
        year: 2002,
        map: 'flipside.if-occurrences-2002',
      },
      {
        year: 2003,
        map: 'flipside.if-occurrences-2003',
      },
      {
        year: 2004,
        map: 'flipside.if-occurrences-2004',
      },
      {
        year: 2005,
        map: 'flipside.if_occurrences-2005',
      },
      {
        year: 2006,
        map: 'flipside.if_occurrences-2006',
      },
      {
        year: 2007,
        map: 'flipside.if_occurrences-2007',
      },
      {
        year: 2008,
        map: 'flipside.if_occurrences-2008',
      },
      {
        year: 2009,
        map: 'flipside.if_occurrences-2009',
      },
      {
        year: 2010,
        map: 'flipside.if_occurrences-2010',
      },
      {
        year: 2011,
        map: 'flipside.if_occurrences-2011'
      }
    ];

    // Create the map.
    var map = mapbox.map('map');
    map.addLayer(mapbox.layer().id(base_map).composite(false));

    // Add Layers
    for (var i = 0; i < layers.length; i++) {
      var l = mapbox.layer().id(layers[i].map);
      // Leave the first layer enabled.
      if (i != 0) {
        l.disable();
      }
      // Set composite to false to be able to control each layer's oapcity.
      l.composite(false);
      map.addLayer(l);


      // Map links
      // TODO: properly format.
      var $a = $('<a href="' + layers[i].map + '">');
      $a.text(layers[i].year);
      $a.css('display', 'block');

      // Click handler for map links
      $a.click(function(){
        sliding = false;
        $control_link.text('play');

        // Vars.
        var map_to_show = $(this).attr('href');
        var current_map = map.getLayer(map_to_show);
        var current_map_map = current_map.id();

        for (var j = 0; j < layers.length; j++) {
          // Disable all layers.
          map.getLayer(layers[j].map).disable();

          // Store the active layer index.
          if (layers[j].map == current_map_map) {
            active_layer = j;
          }
        }

        // Enable and set opacity to max.
        current_map.enable().parent.style.opacity = 1;

        return false;
      });

      $('.map-links').append($a);
    }



    // TODO: add properly.
    var $control_link = $('<a href="#">').text('stop');
    $control_link.click(function(){
      if (sliding) {
        sliding = false;
        clearTimeout(timeout);
        $(this).text('play');
        l_out.disable();
        l_in.parent.style.opacity = 1;
      }
      else {
        sliding = true;
        $(this).text('stop');
        layer_slider();
      }
      console.debug('---' + active_layer + '---');
      return false;
    });
    $('.map-links').append($control_link);



    map.zoom(8);
    map.center({ lat: 40.7168, lon: -7.8674 });

    // Declare interval to cycle.
    var layer_slider = function(){
      // Add +1 to account for the base map.
      // Disable current layer.
      l_out = map.getLayerAt(active_layer + 1);
      // Fade out the layer.
      layer_out(l_out);
      // Get correct layer position.
      if (++active_layer > layers.length - 1) {
        active_layer = 0;
      }
      // Enable next layer.
      l_in = map.getLayerAt(active_layer + 1);
      // Set opacity to 0.
      l_in.parent.style.opacity = 0;
      // Enable the layer.
      l_in.enable();
      // Fade in layer.
      layer_in(l_in);

      // Recursive Call.
      if (sliding && focused) {
        timeout = setTimeout(layer_slider, 2500);
      }
    };
    timeout = setTimeout(layer_slider, 2500);

    /**
     * Fade out layer.
     */
    function layer_out(l){
      l.parent.style.opacity -= 0.1;

      console.debug('decreasing opacity: ' + l.parent.style.opacity);

      if (l.parent.style.opacity <= 0) {
        l.parent.style.opacity = 0;
        l.disable();
      }
      else {
        // Run again.
        if (sliding && focused) {
          l_out_timeout = setTimeout(function(){ layer_out(l) }, 100);
        }
      }
    }

    /**
     * Fade in layer.
     */
    function layer_in(l){
      l.parent.style.opacity = parseFloat(l.parent.style.opacity) + 0.1;

      console.debug('increasing opacity: ' + l.parent.style.opacity);

      if (l.parent.style.opacity >= 1) {
        l.parent.style.opacity = 1;
      }
      else {
        // Run again.
        if (sliding && focused) {
          l_in_timeout = setTimeout(function(){ layer_in(l) }, 100);
        }
      }
    }

    // Corrects bug with changing window.
    // http://stackoverflow.com/questions/6032429/chrome-timeouts-interval-suspended-in-background-tabs
    window.addEventListener('focus', function(){
      focused = true;
      if (sliding) {
        layer_in(l_in);
        layer_out(l_out);
        timeout = setTimeout(layer_slider, 2500);
      }
    });

    window.addEventListener('blur', function(){
      focused = false;
      // Clear all timeouts.
      clearTimeout(timeout);
      clearTimeout(l_out_timeout);
      clearTimeout(l_in_timeout);
      if (sliding) {
        l_in.parent.style.opacity = 1;
        l_out.disable();
      }
    });

  });
  </script>

</body>
</html>
